<!--TODO: standardize the path with the other controls-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="editor-cell.html">

<polymer-element name="wat-keyframe-editor" attribute="keyframeEffect">
	<template>
		<style>
			#grid_container {
				display: grid;
				grid-auto-columns: 1fr;
				grid-auto-rows: 1rf;
			}
		</style>
		<div id="grid_container"></div>
	</template>
	<script>
		Polymer('wat-keyframe-editor', {
			
			grids: null,
			keyframeEffect: null,

			created: function () {
				this.addEventListener("editor-cell-deselect", function(e) {
					for(var i = 0; i < this.grids.length; i++) {
						this.grids[i].select = false;
					}
				});
			},

			keyframeEffectChanged: function(oldValue, newValue) {
				this.update();
			},
			
			update: function() {

				/*create an item and insert it into the grid layout at (row, column)*/
				var createGridItem = function(row, col, content, container) {
					
					var item = document.createElement("editor-cell");
					item.id = "cell_" + row + "_" + col;
					item.style.gridColumn = col;
					item.style.gridRow = row;

					if(content !== 0 && !content) {
						content = "  ";
					}

					item.content = content;
					
					this.grids.push(item);
					container.appendChild(item);

					return item;
				}

				var frames = this.keyframeEffect.getFrames();

				//the set of properties to display
				var found = {offset:true};
				var properties = [];

				//O(n * m), need to loop through all the frames
				//for each frame loop through the properties
				for(var i = 0; i < frames.length; i++) {
				  	for(var prop in frames[i]) {
					  
					 	if(found[prop]) {
						 	continue;
					  	}

					  	found[prop] = true;
					  	properties.push(prop);
				  	}
				}

				var frameTable = this.$.grid_container;


				var gridItem, row, col;
				this.grids = [];
				//create the top left empty cell
				var gridItem = createGridItem(1, 1, "properties \\ offset");
				this.grids.push(gridItem);
				frameTable.appendChild(gridItem);


				//create the row headings
				for(var i = 0; i < properties.length; i++) {
					row = i + 2;
					gridItem = createGridItem(row, 1, properties[i]);
					this.grids.push(gridItem);
					frameTable.appendChild(gridItem);
				}

				
				//create the headings
				for(var i = 0; i < frames.length; i++) {
					col = i + 2;
				 	gridItem = createGridItem(1, col, frames[i].offset);
				 	this.grids.push(gridItem);
				 	frameTable.appendChild(gridItem);
				}

				var prop;
				//fill the rest of the tables
				for(var i = 0; i < frames.length; i++) {
					for(var j = 0; j < properties.length; j++) {
						row = j + 2;
						col = i + 2;
						prop = properties[j];
						gridItem = createGridItem(row, col, frames[i][prop]);
						this.grids.push(gridItem);
						frameTable.appendChild(gridItem);
					}
				}
			}
		});
	</script>
</polymer-element>